<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>metrics-reality – Data Woman</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.svg" rel="icon" type="image/svg+xml">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Data Woman</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-data-for-science" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Data for Science</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-data-for-science">    
        <li>
    <a class="dropdown-item" href="../pages/ether0.html">
 <span class="dropdown-text">Science AI in 2025</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../pages/ai-earlyeve.html">
 <span class="dropdown-text">Science AI in 2023</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-making-orgs-work" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Making Orgs Work</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-making-orgs-work">    
        <li>
    <a class="dropdown-item" href="../pages/metrics-reality.html">
 <span class="dropdown-text">What metrics are for</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../pages/posit-keynote.html">
 <span class="dropdown-text">Starting up data science</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../pages/agile-for-ds.html">
 <span class="dropdown-text">Agile for data science</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../pages/pain-of-ds.html">
 <span class="dropdown-text">The pain of DS in orgs</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-tech-tools" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Tech Tools</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-tech-tools">    
        <li>
    <a class="dropdown-item" href="../pages/serverless-apps.html">
 <span class="dropdown-text">Serverless data apps</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../pages/vibe-coding.html">
 <span class="dropdown-text">Why vibe coding</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-the-nature-of-ai" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">The nature of AI</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-the-nature-of-ai">    
        <li>
    <a class="dropdown-item" href="../pages/bitter-lesson.html">
 <span class="dropdown-text">The human experience</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../pages/how-llms-work.html">
 <span class="dropdown-text">What is an AI model, really?</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-best-use-of-metrics" id="toc-the-best-use-of-metrics" class="nav-link active" data-scroll-target="#the-best-use-of-metrics">The best use of metrics</a>
  <ul class="collapse">
  <li><a href="#what-is-real" id="toc-what-is-real" class="nav-link" data-scroll-target="#what-is-real">What is real?</a>
  <ul class="collapse">
  <li><a href="#its-impossible-to-overcommunicate" id="toc-its-impossible-to-overcommunicate" class="nav-link" data-scroll-target="#its-impossible-to-overcommunicate">It’s impossible to overcommunicate</a></li>
  <li><a href="#its-easy-to-get-out-of-touch" id="toc-its-easy-to-get-out-of-touch" class="nav-link" data-scroll-target="#its-easy-to-get-out-of-touch">It’s easy to get out of touch</a></li>
  <li><a href="#persuasion-seeps-in" id="toc-persuasion-seeps-in" class="nav-link" data-scroll-target="#persuasion-seeps-in">Persuasion seeps in</a></li>
  </ul></li>
  <li><a href="#how-to-solve-this" id="toc-how-to-solve-this" class="nav-link" data-scroll-target="#how-to-solve-this">How to solve this</a>
  <ul class="collapse">
  <li><a href="#design-and-codify" id="toc-design-and-codify" class="nav-link" data-scroll-target="#design-and-codify">Design and codify</a></li>
  <li><a href="#relentlessly-circle-back" id="toc-relentlessly-circle-back" class="nav-link" data-scroll-target="#relentlessly-circle-back">Relentlessly circle back</a></li>
  <li><a href="#value-problem-solving-over-messaging" id="toc-value-problem-solving-over-messaging" class="nav-link" data-scroll-target="#value-problem-solving-over-messaging">Value problem solving over messaging</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">




<section id="the-best-use-of-metrics" class="level1">
<h1>The best use of metrics</h1>
<div class="lead" style="margin: 1.5em 0;">
<p><strong>The most valuable use of metrics is to 1) <em>create a shared understanding of reality</em> and 2) <em>generate constructive conversation</em>.</strong></p>
<p><strong>Do this by identifying key metrics, <em>relentlessly</em> revisiting them, and using them as a starting point for discussion.</strong></p>
</div>
<section id="what-is-real" class="level2">
<h2 class="anchored" data-anchor-id="what-is-real">What is real?</h2>
<p>First, let’s talk about why creating a shared understanding of reality is an objective worth focusing on. Does everyone in your organization have the same view of how the company is doing, and where the successes and challenges are? <strong>Assume no.</strong> The default state of affairs is that everyone has a different perspective, each of which is wrong in some way. This inherently leads to out-of-sync decision making, as people make reasonable choices based on different understandings of reality. (For more on this, I recommend this <a href="https://benn.substack.com/p/data-is-for-dashboards">article by Benn Stancil</a>.)</p>
<p>There are several reasons why it’s so hard to have an accurate, shared view of reality.</p>
<p><img src="../images/arrow.png" style="float: right; width: 40%;" alt=""></p>
<section id="its-impossible-to-overcommunicate" class="level3">
<h3 class="anchored" data-anchor-id="its-impossible-to-overcommunicate">It’s impossible to overcommunicate</h3>
<p>Even in the unlikely case that members of an executive team have a common understanding of where things stand, it’s almost certainly true that individual contributors do not. This is partly due to communication from executives outward. While leaders are immersed in thinking about the big picture and adapting longer term plans, everyone else is focused on the details of the day to day. An executive may have had five meetings about something, and it’s inherently informing their thinking. They may not even recognize that it hasn’t been communicated to the rest of the organization – or perhaps it has, but without people fully absorbing it. It’s very common for leaders to think they’ve clearly explained something when the actual level of understanding is little to none.</p>
</section>
<section id="its-easy-to-get-out-of-touch" class="level3">
<h3 class="anchored" data-anchor-id="its-easy-to-get-out-of-touch">It’s easy to get out of touch</h3>
<p>While company leaders are well informed about some aspects of a company’s situation, they are often out of touch with the day to day realities. This is natural, as they’re focused on a different set of activities. However, it often leads to a disconnect on critical issues. This can happen between executives and individual contributors within organizations, and also between entire companies and their customers. Sometimes a single experience can suddenly make this clear. For example, in 2023 Jim Farley, the CEO of Ford, <a href="https://www.businessinsider.com/ford-ceo-electric-f-150-road-trip-charging-reality-check-2023-8">took the EV version of the F-150, the Ford Lightning, on a road trip</a>, where he quickly adjusted his view of reality.</p>
</section>
<section id="persuasion-seeps-in" class="level3">
<h3 class="anchored" data-anchor-id="persuasion-seeps-in">Persuasion seeps in</h3>
<p>There are many ways metrics are used in organizations, particularly to evaluate company and individual performance. In these cases there is an inherent bias towards making things look good. Whether it’s the CEO pitching the company to investors, the marketing team making a case to customers, executives updating employees, or individuals maximizing metrics tied to their compensation, there are incentives to present the most optimistic version of reality. The problem is that this optimistic version tends to become the main understanding, often without anyone even realizing it.</p>
</section>
</section>
<section id="how-to-solve-this" class="level2">
<h2 class="anchored" data-anchor-id="how-to-solve-this">How to solve this</h2>
<p>Using metrics well is like giving everyone in your organization glasses that suddenly make things clear. To do this, you to carefully select metrics and make them precise, keep returning to them repeatedly over time, and approach them with the goal of understanding and problem solving, rather than using them for positive messaging.</p>
<p><img src="../images/glasses.png" style="float: left; width: 40%;" alt=""></p>
<section id="design-and-codify" class="level3">
<h3 class="anchored" data-anchor-id="design-and-codify">Design and codify</h3>
<p>First, decide what elements of your strategy or operations are more critical to represent in metrics. There are probably many; start with just a handful and expand over time. It’s much better to get this process up and running successfully with three metrics that everyone truly understands, remembers, and can talk about, than to have a comprehensive set that leaves people behind.</p>
<p>Once you decide what your first metrics will be, you need to <em>really precisely define them</em>. Try to do this in words, then have someone who works with data try to do it with code (such as SQL, R, or python). Or if you don’t have such a person, implement a calculation from data to the metric in a spreadsheet. The important thing here is that you start with a standardized set of “raw” data that is updated regularly, and includes the information needed to calculate your metrics. For example, at EvE Bio, we record every assay that enters the assay development process, metadata about the assay type, the date when development started, the protocol number that results, the date the protocol was approved, a checkbox for assays that did not result in a protocol, and a standardized set of reasons for this. From this we can calculate things like protocols published per week, average time in assay development by assay type, assay development success rate, etc. When we look at these metrics, we don’t ask someone to provide a number, we have it automatically calculated with code directly from the same dataset every time.</p>
<p>This might seem overly rigid especially if your metrics aren’t that hard to calculate. The reason you should still do this with code is that it forces everyone to agree on a single, precise definition of the metric that is consistent over time, and a single version of the data the metric is based on that is also consistent over time. It is very often the case that people verbally agree on a metric to track, but that when someone tries to implement its calculation in code, many specific questions arise. Being forced to work through these up front avoids common problems in which what seem like the same metrics are calculated differently by different people (or even the same person) over time, which immediately makes them less useful. There is no room for hand waving in code.</p>
<p>Note: It’s certainly not the case that all important things can be reduced to numbers. However, metrics provide a concrete anchor for our understanding of reality, so it’s a good place to start. More qualitative information can fill in the picture around the numbers, and tightly coupled quantitative measurement and qualitative research is a powerful combination.</p>
</section>
<section id="relentlessly-circle-back" class="level3">
<h3 class="anchored" data-anchor-id="relentlessly-circle-back">Relentlessly circle back</h3>
<p>Once you have a small set of key metrics that are precisely and automatically calculated, your task is to return to them <em>relentlessly</em>. Continuing to look at the same numbers over time is often the obvious goal, but is easy to stray from. It can seem pedantic, but repetition is necessary to establish things in people’s thinking. I once worked at a startup where someone was selected at every company meeting to read our mission and our strategy. Sometimes this felt a bit silly, but it was effective. Don’t worry about overcommunicating, it’s virtually impossible to do.</p>
<p>The most common reason I’ve seen metrics fade from ongoing review is when things aren’t going as well as expected. Leaders get nervous about calling attention to problems, often because of concerns about damaging morale. However, employees generally pick up on this, and it’s more empowering to have an opportunity to be part of a solution than to be “protected” from bad news.</p>
</section>
<section id="value-problem-solving-over-messaging" class="level3">
<h3 class="anchored" data-anchor-id="value-problem-solving-over-messaging">Value problem solving over messaging</h3>
<p>The goal of developing a shared understanding of reality is to take effective action. This means facing things head on, both good and bad, rather than trying to change the messaging to reassure everyone about the current situation. If the metrics indicate that reality is not what you hoped, it’s an opportunity to engage everyone in the problem solving process to get back on track or change course.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/datawoman\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>